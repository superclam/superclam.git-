<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>联机贪吃蛇游戏</title>
  <style>
    body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f0f0; }
    #game-container { position: relative; }
    canvas { border: 2px solid #333; }
    #scoreboard { position: absolute; top: 10px; left: 10px; color: white; font-family: Arial, sans-serif; }
    #connection-status { position: absolute; top: 10px; right: 10px; color: white; font-family: Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <div id="scoreboard">分数: 0</div>
    <div id="connection-status">未连接</div>
  </div>

  <script>
    // 游戏常量
    const GRID_SIZE = 20;
    
    // 游戏变量
    let canvas, ctx;
    let snake = [{ x: 10, y: 10 }];
    let food = { x: 5, y: 5 };
    let score = 0;
    let playerId;
    let connectionStatus = document.getElementById('connection-status');
    let scoreboard = document.getElementById('scoreboard');
    let ws;

    // 初始化游戏
    function initGame() {
      canvas = document.getElementById('gameCanvas');
      ctx = canvas.getContext('2d');
      
      // 监听方向变化
      document.addEventListener('keydown', handleKeyPress);
      
      // 连接WebSocket服务器
      connectWebSocket();
    }

    // 连接WebSocket服务器
    function connectWebSocket() {
      // 使用Codespaces提供的URL或本地地址
      const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      const host = window.location.hostname === 'localhost' ? 'localhost:5000' : window.location.hostname;
      const port = window.location.hostname === 'localhost' ? '' : ':443';
      
      ws = new WebSocket(`${protocol}${host}${port}`);
      
      // 连接成功
      ws.onopen = () => {
        connectionStatus.textContent = '已连接';
        console.log('WebSocket连接成功');
      };
      
      // 接收消息
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          switch (data.type) {
            case 'player-id':
              playerId = data.data;
              console.log('玩家ID:', playerId);
              break;
              
            case 'game-update':
              updateGameState(data.data);
              break;
          }
        } catch (error) {
          console.error('Error parsing WebSocket message:', error);
        }
      };
      
      // 连接关闭
      ws.onclose = () => {
        connectionStatus.textContent = '已断开';
        console.log('WebSocket连接已关闭');
        
        // 尝试重新连接
        setTimeout(connectWebSocket, 3000);
      };
      
      // 连接错误
      ws.onerror = (error) => {
        connectionStatus.textContent = '连接错误';
        console.error('WebSocket连接错误:', error);
      };
    }

    // 处理键盘输入
    function handleKeyPress(e) {
      if (!playerId || ws.readyState !== WebSocket.OPEN) return;
      
      let direction;
      
      switch (e.keyCode) {
        case 37: // 左
          direction = 'LEFT';
          break;
        case 38: // 上
          direction = 'UP';
          break;
        case 39: // 右
          direction = 'RIGHT';
          break;
        case 40: // 下
          direction = 'DOWN';
          break;
        default:
          return;
      }
      
      // 发送方向变化到服务器
      ws.send(JSON.stringify({
        type: 'direction',
        direction
      }));
    }

    // 更新游戏状态
    function updateGameState(data) {
      snake = data.snakes[playerId] || snake;
      food = data.food;
      score = data.scores[playerId] || 0;
      scoreboard.textContent = `分数: ${score}`;
      draw();
    }

    // 绘制游戏
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 绘制所有玩家的蛇
      for (const id in gameState.snakes) {
        const playerSnake = gameState.snakes[id];
        ctx.fillStyle = id === playerId ? 'green' : 'blue';
        
        playerSnake.forEach(segment => {
          ctx.fillRect(segment.x * GRID_SIZE, segment.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
          ctx.strokeStyle = id === playerId ? 'darkgreen' : 'darkblue';
          ctx.strokeRect(segment.x * GRID_SIZE, segment.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
        });
      }
      
      // 绘制食物
      ctx.fillStyle = 'red';
      ctx.fillRect(food.x * GRID_SIZE, food.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
    }

    // 启动游戏
    window.onload = initGame;
  </script>
</body>
</html>
